services:
  frigate:
    container_name: frigate
    restart: unless-stopped
    stop_grace_period: 30s
    image: ghcr.io/blakeblackshear/frigate:stable
    # Use development image if you want to test your local changes
    # build:
    #   context: .
    #   dockerfile: docker/main/Dockerfile

    shm_size: '512mb' # Adjust based on your camera count and resolution

    volumes:
      # Mount your config directory (rw for config migrations)
      # Note: Database and model_cache use separate volumes to avoid Windows filesystem issues
      - ./config:/config:rw
      # Use named volume for database (avoids SQLite I/O errors on Windows filesystems)
      - frigate_db:/db
      # Mount storage for recordings, clips, etc.
      - ./input:/media/frigate:rw
      # Mount local web build to COMPLETELY override container's pre-built web files
      # This ensures all old favicon files in /opt/frigate/web/assets/ are replaced
      - ./web/dist:/opt/frigate/web:ro
      # Use tmpfs for cache (eliminates Windows path issues)
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000 # 1GB cache in memory
      # Use named volume for model_cache (writable, persists across restarts)
      - frigate_model_cache:/config/model_cache

    ports:
      - "8971:8971" # Web UI (HTTPS)
      - "5000:5000" # Internal API (HTTP, unauthenticated - use carefully)
      - "5001:5001" # Internal API (HTTP, authenticated)
      - "8554:8554" # RTSP feeds
      - "8555:8555/tcp" # WebRTC over TCP
      - "8555:8555/udp" # WebRTC over UDP

    environment:
      # Set timezone (adjust to your location)
      - TZ=Asia/Kolkata
      # RTSP password for go2rtc
      - FRIGATE_RTSP_PASSWORD=password
      # Optional: Set config directory
      - FRIGATE_CONFIG_DIR=/config
    # Optional: For hardware acceleration (if you have compatible GPU)
    # devices:
    #   - /dev/dri/renderD128  # Intel GPU
    #   - /dev/dri/card0       # AMD GPU

    # Optional: For USB Coral TPU
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb

    # Optional: Enable if you need privileged mode (for some hardware)
    # privileged: true

volumes:
  # Named volume for model cache (writable, avoids Windows bind mount issues)
  frigate_model_cache: # Named volume for database (avoids SQLite I/O errors on Windows filesystems)

  frigate_db:
