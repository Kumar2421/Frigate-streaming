services:
  frigate:
    container_name: frigate
    restart: unless-stopped
    stop_grace_period: 30s
    # Use your pre-built custom image pushed to registry
    # image: kumar2421/frigate-custom:1.0.0
    # If you prefer building locally instead of pulling:
    build:
      context: .
      dockerfile: custom-detector/Dockerfile

    shm_size: '512mb' # Adjust based on your camera count and resolution

    volumes:
      # Mount your config directory (rw for config migrations)
      # Note: Database and model_cache use separate volumes to avoid Windows filesystem issues
      - ./config:/config:rw
      # # Dev: bind-mount python source so small code changes only need restart (no rebuild)
      # - ./frigate:/opt/frigate/frigate:rw
      # Use named volume for database (avoids SQLite I/O errors on Windows filesystems)
      - frigate_db:/db
      # Mount storage for recordings, clips, etc.
      - ./input:/media/frigate:rw
      # Bind-mount testinput directory so files are visible at /media/frigate/testinput
      - ./testinput:/media/frigate/testinput:ro
      # Use built-in web UI from the image. Uncomment to override with local dist:
      - ./web/dist:/opt/frigate/web:ro
      # Use tmpfs for cache (eliminates Windows path issues)
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000 # 1GB cache in memory
      # Use named volume for model_cache (writable, persists across restarts)
      - frigate_model_cache:/config/model_cache

    ports:
      - "8971:8971" # Web UI (HTTPS)
      - "5000:5000" # Internal API (HTTP, unauthenticated - use carefully)
      - "5001:5001" # Internal API (HTTP, authenticated)
      - "8554:8554" # RTSP feeds
      - "8555:8555/tcp" # WebRTC over TCP
      - "8555:8555/udp" # WebRTC over UDP

    environment:
      # Set timezone (adjust to your location)
      - TZ=Asia/Kolkata
      # RTSP password for go2rtc
      - FRIGATE_RTSP_PASSWORD=password
      # Optional: Set config directory
      - FRIGATE_CONFIG_DIR=/config
      # Fire detection model configuration
      # - FIRE_MODEL_PATH=/config/yolov8n_opset21.onnx
      # - FIRE_THRESHOLD=0.25
      # Face detection model configuration (secondary detector)
      - FACE_MODEL_PATH=/config/yolov8n-face-lindevs.pt
      - FACE_THRESHOLD=0.25
      # Save directory for YOLO annotated frames (inside container and mapped to host)
      - YOLO_SAVE_DIR=/config/yolo
      - FACE_ALWAYS_RUN=0
      - FIRE_ALWAYS_RUN=0
      # Draw DeepSORT IDs and boxes on saved clip images
      - DRAW_CLIP_OVERLAYS=1
      - CLIPS_OUTPUT_DIR=/media/frigate/clips
    # Optional: For hardware acceleration (if you have compatible GPU)
    # devices:
    #   - /dev/dri/renderD128  # Intel GPU
    #   - /dev/dri/card0       # AMD GPU

    # Optional: For USB Coral TPU
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb

    # Optional: Enable if you need privileged mode (for some hardware)
    # privileged: true

volumes:
  # Named volume for model cache (writable, avoids Windows bind mount issues)
  frigate_model_cache: # Named volume for database (avoids SQLite I/O errors on Windows filesystems)

  frigate_db:
